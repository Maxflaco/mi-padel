<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Pro - ELO Evolution</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; color: #34495e; }
        .container { max-width: 900px; margin: auto; }
        h1, h2 { text-align: center; color: #1a2a3a; margin-bottom: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-blue { background: #3498db; }
        .btn-orange { background: #f39c12; }
        .btn-danger { background: #e74c3c; width: auto; padding: 8px 15px; font-size: 13px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; font-size: 14px; }
        th { background-color: #f8f9fa; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .badge-win { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .elo-tag { font-weight: bold; color: #2c3e50; background: #ecf0f1; padding: 3px 8px; border-radius: 12px; font-size: 0.9em;}
    </style>
</head>
<body>

<div class="container">
    <h1>üéæ Padel Pro <span style="color:#3498db">Evolution</span></h1>

    <div class="card">
        <h2>üë• Jugadores</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="new-player-name" placeholder="Nombre...">
            <button class="btn-blue" style="width: auto;" onclick="agregarJugador()">A√±adir</button>
        </div>
        <div id="players-list"></div>
    </div>

    <div class="card" style="background: #fdfffe; border-left: 4px solid #2ecc71;">
        <h2>Nuevo Partido</h2>
        <div class="grid-inputs">
            <div>
                <label style="font-weight: bold; color: #27ae60;">Pareja 1 (Ganadores?)</label>
                <select id="p1a" class="player-select"></select>
                <select id="p1b" class="player-select"></select>
                <input type="number" id="score1" value="0" placeholder="Sets ganados">
            </div>
            <div>
                <label style="font-weight: bold; color: #c0392b;">Pareja 2</label>
                <select id="p2a" class="player-select"></select>
                <select id="p2b" class="player-select"></select>
                <input type="number" id="score2" value="0" placeholder="Sets ganados">
            </div>
        </div>
        <button onclick="agregarPartido()">Registrar Resultado</button>
    </div>

    <div class="card">
        <h2>üìà Evoluci√≥n de Rating ELO</h2>
        <p style="text-align: center; font-size: 0.9em; color: #7f8c8d;">Historial completo de todos los partidos</p>
        <div class="chart-container"><canvas id="eloChart"></canvas></div>
    </div>

    <div class="card">
        <h2>üèÜ Clasificaci√≥n Actual (ELO)</h2>
        <div style="overflow-x: auto;">
        <table id="stats-table">
            <thead><tr><th>Rank</th><th>Jugador</th><th>ELO</th><th>PJ</th><th>% Victorias</th></tr></thead>
            <tbody id="stats-body"></tbody>
        </table>
        </div>
    </div>

    <div class="card">
        <h2>Ranking de Parejas (Temporada)</h2>
         <div style="display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
            <input type="date" id="date-start" style="width: auto;">
            <span style="align-self: center;">a</span>
            <input type="date" id="date-end" style="width: auto;">
            <button class="btn-blue" onclick="actualizarInterfaz()" style="width:auto; margin-top:0;">Filtrar Tablas</button>
        </div>
        <div style="overflow-x: auto;">
        <table id="teams-table">
            <thead><tr><th>Pareja</th><th>PJ</th><th>V</th><th>%</th></tr></thead>
            <tbody id="teams-body"></tbody>
        </table>
        </div>
    </div>

     <div class="card">
        <h2>üíæ Gesti√≥n de Datos</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <button class="btn-orange" onclick="exportarDatos()">‚¨áÔ∏è Exportar Backup</button>
            <div style="display: flex; flex-direction: column;">
                 <label for="import-file" class="btn-blue" style="text-align:center; cursor:pointer; padding: 12px; margin-top: 10px; border-radius: 6px; font-weight: bold;">‚¨ÜÔ∏è Importar Backup</label>
                <input type="file" id="import-file" style="display: none;" onchange="importarDatos()">
            </div>
        </div>
        <button class="btn-danger" style="width: 100%; opacity: 0.7;" onclick="borrarTodo()">‚ö†Ô∏è Reiniciar Todo el Sistema</button>
    </div>

    <div class="card">
        <h2>Historial Reciente</h2>
        <div style="overflow-x: auto;">
        <table id="history-table"><tbody id="history-body"></tbody></table>
        </div>
    </div>
</div>

<script>
    let jugadores = JSON.parse(localStorage.getItem('padelPlayers')) || ["Ana", "Betico", "Carlos", "Diana"];
    let historial = JSON.parse(localStorage.getItem('padelMatches')) || [];
    let chartInstance = null;
    const ELO_INICIAL = 1000;
    const K_FACTOR = 32;

    // --- L√ìGICA ELO ---
    function calcularCambioElo(ratingEquipo, ratingOponente, gano) {
        const expectativa = 1 / (1 + Math.pow(10, (ratingOponente - ratingEquipo) / 400));
        // Si empatan en sets (ej 1-1 en un partido inconcluso), consideramos empate (0.5)
        let resultado = gano ? 1 : 0;
        return Math.round(K_FACTOR * (resultado - expectativa));
    }
    
    // Colores para el gr√°fico
    const chartColors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#34495e', '#16a085', '#27ae60', '#2980b9', '#8e44ad', '#d35400', '#c0392b'];
    function getColor(index) { return chartColors[index % chartColors.length]; }

    // --- FUNCIONES DE BACKUP ---
    function exportarDatos() {
        const data = { jugadores, historial };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "padel_elo_evolution_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode); // Required for Firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importarDatos() {
        const fileInput = document.getElementById('import-file');
        if (!fileInput.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(data.jugadores && data.historial){
                    jugadores = data.jugadores; historial = data.historial;
                    localStorage.setItem('padelPlayers', JSON.stringify(jugadores));
                    localStorage.setItem('padelMatches', JSON.stringify(historial));
                    location.reload();
                } else { alert("Formato de archivo incorrecto"); }
            } catch(err) { alert("Error al leer el archivo"); }
        };
        reader.readAsText(fileInput.files[0]);
    }

    // --- GESTI√ìN DE INTERFAZ ---
    const hoy = new Date();
    document.getElementById('date-start').value = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = hoy.toISOString().split('T')[0];

    function renderJugadores() {
        const list = document.getElementById('players-list');
        list.innerHTML = '';
        jugadores.forEach((n, i) => {
            list.innerHTML += `<div class="player-item"><span>${n}</span><button class="btn-danger" style="padding: 4px 10px;" onclick="eliminarJugador(${i})">‚úï</button></div>`;
        });
        actualizarSelectores();
    }

    function actualizarSelectores() {
        document.querySelectorAll('.player-select').forEach(s => {
            const currentVal = s.value;
            s.innerHTML = '';
            jugadores.forEach(j => s.add(new Option(j, j)));
            if (jugadores.includes(currentVal)) s.value = currentVal;
        });
    }

    function agregarJugador() {
        const name = document.getElementById('new-player-name').value.trim();
        if (name && !jugadores.includes(name)) {
            jugadores.push(name);
            localStorage.setItem('padelPlayers', JSON.stringify(jugadores));
            renderJugadores();
            actualizarInterfaz();
            document.getElementById('new-player-name').value = '';
        }
    }

    function eliminarJugador(i) {
        if(confirm("¬øEliminar jugador? Su historial de partidos permanecer√° pero no aparecer√° en rankings futuros.")) { 
            jugadores.splice(i, 1); 
            localStorage.setItem('padelPlayers', JSON.stringify(jugadores)); 
            renderJugadores(); 
            actualizarInterfaz(); 
        }
    }

    function agregarPartido() {
        const p1 = [document.getElementById('p1a').value, document.getElementById('p1b').value];
        const p2 = [document.getElementById('p2a').value, document.getElementById('p2b').value];
        const s1 = parseInt(document.getElementById('score1').value) || 0;
        const s2 = parseInt(document.getElementById('score2').value) || 0;
        
        if (new Set([...p1, ...p2]).size !== 4) return alert("Error: Jugadores repetidos en el partido.");
        if (s1 === 0 && s2 === 0) return alert("Introduce el resultado en sets.");

        historial.unshift({ timestamp: new Date().toISOString(), p1, p2, s1, s2 });
        localStorage.setItem('padelMatches', JSON.stringify(historial));
        actualizarInterfaz();
        // Reset scores
        document.getElementById('score1').value = 0; document.getElementById('score2').value = 0;
    }

    function actualizarInterfaz() {
        const startStr = document.getElementById('date-start').value;
        const endStr = document.getElementById('date-end').value;
        const start = startStr ? new Date(startStr) : new Date(0);
        const end = endStr ? new Date(endStr) : new Date();
        end.setHours(23, 59, 59);

        const statsInd = {};
        const statsPar = {};
        // Estructura para el gr√°fico de l√≠neas: { "JugadorA": [{x:1, y:1000}, {x:5, y:1020}], ... }
        const eloHistoryDatasets = {}; 

        // Inicializar stats y datasets con punto de partida (partido 0)
        jugadores.forEach(j => {
            statsInd[j] = { elo: ELO_INICIAL, v: 0, p: 0 };
            eloHistoryDatasets[j] = [{x: 0, y: ELO_INICIAL}]; 
        });

        const historialCronologico = [...historial].reverse();
        
        historialCronologico.forEach((m, index) => {
            // Asegurar existencia en stats (para jugadores borrados que vuelven a aparecer en historial viejo)
            [...m.p1, ...m.p2].forEach(j => {
                 if(!statsInd[j]) statsInd[j] = { elo: ELO_INICIAL, v: 0, p: 0 };
                 if(!eloHistoryDatasets[j]) eloHistoryDatasets[j] = [{x: 0, y: ELO_INICIAL}];
            });

            // 1. C√ÅLCULO ELO (Siempre se calcula todo el historial)
            const eloPromT1 = (statsInd[m.p1[0]].elo + statsInd[m.p1[1]].elo) / 2;
            const eloPromT2 = (statsInd[m.p2[0]].elo + statsInd[m.p2[1]].elo) / 2;
            
            let diff = 0;
            if (m.s1 !== m.s2) {
                 diff = calcularCambioElo(eloPromT1, eloPromT2, m.s1 > m.s2);
            }

            // Aplicar y guardar historia
            [...m.p1, ...m.p2].forEach(j => {
                 if (m.s1 !== m.s2) {
                    if (m.p1.includes(j)) statsInd[j].elo += diff;
                    else statsInd[j].elo -= diff;
                 }
                 // Guardamos el punto en el gr√°fico: X = n√∫mero de partido (index+1), Y = nuevo Elo
                 eloHistoryDatasets[j].push({x: index + 1, y: statsInd[j].elo});
            });

            // 2. FILTRADO PARA TABLAS DE ESTAD√çSTICAS (PJ, V%)
            const fechaM = new Date(m.timestamp);
            if (fechaM >= start && fechaM <= end) {
                m.p1.forEach(j => statsInd[j].p++);
                m.p2.forEach(j => statsInd[j].p++);
                
                const t1_key = m.p1.sort().join(" & ");
                const t2_key = m.p2.sort().join(" & ");
                if (!statsPar[t1_key]) statsPar[t1_key] = { v: 0, p: 0 };
                if (!statsPar[t2_key]) statsPar[t2_key] = { v: 0, p: 0 };
                statsPar[t1_key].p++; statsPar[t2_key].p++;

                if (m.s1 > m.s2) {
                    statsInd[m.p1[0]].v++; statsInd[m.p1[1]].v++; statsPar[t1_key].v++;
                } else if (m.s2 > m.s1) {
                    statsInd[m.p2[0]].v++; statsInd[m.p2[1]].v++; statsPar[t2_key].v++;
                }
            }
        });

        // RENDERIZAR TABLAS
        const sBody = document.getElementById('stats-body'); sBody.innerHTML = '';
        Object.entries(statsInd)
            .filter(([n]) => jugadores.includes(n)) // Solo mostrar jugadores activos
            .sort((a,b)=>b[1].elo - a[1].elo)
            .forEach(([n, s], i) => {
            sBody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td style="font-weight:600">${n}</td>
                <td><span class="elo-tag" style="background:${getColor(jugadores.indexOf(n))}20; color:${getColor(jugadores.indexOf(n))}">${s.elo}</span></td>
                <td>${s.p}</td>
                <td>${s.p>0?Math.round((s.v/s.p)*100):0}%</td>
            </tr>`;
        });

        const tBody = document.getElementById('teams-body'); tBody.innerHTML = '';
        Object.entries(statsPar).sort((a,b)=>b[1].v - a[1].v).forEach(([p, s]) => {
            tBody.innerHTML += `<tr><td>${p}</td><td>${s.p}</td><td>${s.v}</td><td><span class="badge-win">${Math.round((s.v/s.p)*100)}%</span></td></tr>`;
        });

        const hBody = document.getElementById('history-body'); hBody.innerHTML = '';
        historial.slice(0, 15).forEach(p => { 
            hBody.innerHTML += `<tr><td style="font-size:0.9em; color:#7f8c8d">${new Date(p.timestamp).toLocaleDateString()}</td><td>${p.p1.join("/")}</td><td style="font-weight:bold; white-space:nowrap;">${p.s1} - ${p.s2}</td><td>${p.p2.join("/")}</td></tr>`; 
        });

        // --- RENDERIZAR GR√ÅFICO DE L√çNEAS ---
        const ctx = document.getElementById('eloChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const datasets = jugadores.map((jugador, i) => ({
            label: jugador,
            data: eloHistoryDatasets[jugador],
            borderColor: getColor(i),
            backgroundColor: getColor(i),
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 6,
            fill: false,
            tension: 0.1 // Un poco de curva para que se vea mejor
        }));

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index', // Muestra el estado de todos los jugadores en ese partido
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'linear', // Eje X num√©rico (secuencia de partidos)
                        title: { display: true, text: 'Secuencia de Partidos Jugados' },
                        ticks: { precision: 0 }
                    },
                    y: {
                        title: { display: true, text: 'Rating ELO' },
                        suggestedMin: 900, // Para que el gr√°fico no empiece siempre desde 0
                        suggestedMax: 1100
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            title: (items) => `Despu√©s del Partido #${items[0].parsed.x}`
                        }
                    }
                }
            }
        });
    }

    function borrarTodo() { if (confirm("‚ö†Ô∏è ¬°ATENCI√ìN! ‚ö†Ô∏è\n\nEsto borrar√° PERMANENTEMENTE todos los jugadores, partidos y el historial de ELO.\n\n¬øEst√°s seguro?")) { localStorage.clear(); location.reload(); } }

    renderJugadores();
    // Peque√±o timeout para asegurar que chart.js carg√≥ antes del primer render
    setTimeout(actualizarInterfaz, 100);
</script>
</body>
</html>