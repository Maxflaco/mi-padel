<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Pro - Backup Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 900px; margin: auto; }
        h1, h2 { text-align: center; color: #1a2a3a; margin-bottom: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: #3498db; }
        .btn-orange { background: #f39c12; }
        .btn-danger { background: #e74c3c; width: auto; padding: 8px 15px; font-size: 13px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; font-size: 14px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .badge-win { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ¾ Padel Pro Tracker</h1>

    <div class="card">
        <h2>ðŸ‘¥ Jugadores</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="new-player-name" placeholder="Nombre...">
            <button class="btn-blue" style="width: auto;" onclick="agregarJugador()">AÃ±adir</button>
        </div>
        <div id="players-list"></div>
    </div>

    <div class="card">
        <h2>Nuevo Partido</h2>
        <div class="grid-inputs">
            <div>
                <label>Pareja 1</label>
                <select id="p1a" class="player-select"></select>
                <select id="p1b" class="player-select"></select>
                <input type="number" id="score1" value="0">
            </div>
            <div>
                <label>Pareja 2</label>
                <select id="p2a" class="player-select"></select>
                <select id="p2b" class="player-select"></select>
                <input type="number" id="score2" value="0">
            </div>
        </div>
        <button onclick="agregarPartido()">Guardar Resultado</button>
    </div>

    <div class="card">
        <h2>ðŸ’¾ Copia de Seguridad</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-orange" onclick="exportarDatos()">Exportar a Archivo</button>
            <div style="display: flex; flex-direction: column;">
                <input type="file" id="import-file" style="font-size: 11px; padding: 5px;">
                <button class="btn-blue" onclick="importarDatos()" style="padding: 5px; font-size: 12px;">Importar Archivo</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Temporada</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="date" id="date-start">
            <input type="date" id="date-end">
            <button class="btn-blue" onclick="actualizarInterfaz()" style="width:auto;">Filtrar</button>
        </div>
        <div class="chart-container"><canvas id="myChart"></canvas></div>
    </div>

    <div class="card">
        <h2>ClasificaciÃ³n Individual</h2>
        <table id="stats-table">
            <thead><tr><th>Jugador</th><th>PJ</th><th>V</th><th>%</th></tr></thead>
            <tbody id="stats-body"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>Ranking de Parejas</h2>
        <table id="teams-table">
            <thead><tr><th>Pareja</th><th>PJ</th><th>V</th><th>%</th></tr></thead>
            <tbody id="teams-body"></tbody>
        </table>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Historial</h2>
            <button class="btn-danger" onclick="borrarTodo()">Reiniciar Todo</button>
        </div>
        <table id="history-table"><tbody id="history-body"></tbody></table>
    </div>
</div>

<script>
    let jugadores = JSON.parse(localStorage.getItem('padelPlayers')) || ["Ana", "Betico", "Carlos", "Diana", "Elena"];
    let historial = JSON.parse(localStorage.getItem('padelMatches')) || [];
    let chartInstance = null;

    // --- FUNCIONES DE BACKUP ---
    
    function exportarDatos() {
        const data = {
            jugadores: jugadores,
            historial: historial
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "padel_backup_" + new Date().toLocaleDateString() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importarDatos() {
        const fileInput = document.getElementById('import-file');
        if (!fileInput.files[0]) return alert("Por favor, selecciona un archivo primero.");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.jugadores && importedData.historial) {
                    jugadores = importedData.jugadores;
                    historial = importedData.historial;
                    localStorage.setItem('padelPlayers', JSON.stringify(jugadores));
                    localStorage.setItem('padelMatches', JSON.stringify(historial));
                    alert("Â¡Datos restaurados con Ã©xito!");
                    location.reload(); // Recargamos para aplicar cambios
                } else {
                    alert("El archivo no tiene el formato correcto.");
                }
            } catch (err) {
                alert("Error al leer el archivo JSON.");
            }
        };
        reader.readAsText(fileInput.files[0]);
    }

    // --- RESTO DE LÃ“GICA (Mantenida) ---

    const hoy = new Date();
    document.getElementById('date-start').value = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = hoy.toISOString().split('T')[0];

    function renderJugadores() {
        const list = document.getElementById('players-list');
        list.innerHTML = '';
        jugadores.forEach((n, i) => {
            list.innerHTML += `<div class="player-item"><span>${n}</span><button class="btn-danger btn-small" onclick="eliminarJugador(${i})">âœ•</button></div>`;
        });
        actualizarSelectores();
    }

    function agregarJugador() {
        const name = document.getElementById('new-player-name').value.trim();
        if (name && !jugadores.includes(name)) {
            jugadores.push(name);
            localStorage.setItem('padelPlayers', JSON.stringify(jugadores));
            renderJugadores();
            actualizarInterfaz();
        }
    }

    function eliminarJugador(i) {
        if(confirm("Â¿Eliminar?")) { jugadores.splice(i, 1); localStorage.setItem('padelPlayers', JSON.stringify(jugadores)); renderJugadores(); actualizarInterfaz(); }
    }

    function actualizarSelectores() {
        document.querySelectorAll('.player-select').forEach(s => {
            const val = s.value;
            s.innerHTML = '';
            jugadores.forEach(j => s.add(new Option(j, j)));
            s.value = val;
        });
    }

    function agregarPartido() {
        const p1 = [document.getElementById('p1a').value, document.getElementById('p1b').value];
        const p2 = [document.getElementById('p2a').value, document.getElementById('p2b').value];
        const s1 = parseInt(document.getElementById('score1').value);
        const s2 = parseInt(document.getElementById('score2').value);
        if (new Set([...p1, ...p2]).size !== 4) return alert("Jugadores repetidos");
        historial.unshift({ timestamp: new Date().toISOString(), p1, p2, s1, s2 });
        localStorage.setItem('padelMatches', JSON.stringify(historial));
        actualizarInterfaz();
    }

    function actualizarInterfaz() {
        const start = new Date(document.getElementById('date-start').value);
        const end = new Date(document.getElementById('date-end').value);
        end.setHours(23, 59, 59);
        const filtrado = historial.filter(p => { const f = new Date(p.timestamp); return f >= start && f <= end; });
        
        const ind = {}; const par = {};
        jugadores.forEach(j => ind[j] = { v: 0, p: 0 });

        filtrado.forEach(p => {
            [...p.p1, ...p.p2].forEach(j => { if(ind[j]) ind[j].p++; });
            const t1 = p.p1.sort().join(" & "); const t2 = p.p2.sort().join(" & ");
            if (!par[t1]) par[t1] = { v: 0, p: 0 }; if (!par[t2]) par[t2] = { v: 0, p: 0 };
            par[t1].p++; par[t2].p++;
            if (p.s1 > p.s2) { if(ind[p.p1[0]]) ind[p.p1[0]].v++; if(ind[p.p1[1]]) ind[p.p1[1]].v++; par[t1].v++; }
            else { if(ind[p.p2[0]]) ind[p.p2[0]].v++; if(ind[p.p2[1]]) ind[p.p2[1]].v++; par[t2].v++; }
        });

        // Tablas
        const sBody = document.getElementById('stats-body'); sBody.innerHTML = '';
        Object.entries(ind).sort((a,b)=>b[1].v - a[1].v).forEach(([n, s]) => {
            sBody.innerHTML += `<tr><td>${n}</td><td>${s.p}</td><td>${s.v}</td><td>${s.p>0?Math.round((s.v/s.p)*100):0}%</td></tr>`;
        });

        const tBody = document.getElementById('teams-body'); tBody.innerHTML = '';
        Object.entries(par).sort((a,b)=>b[1].v - a[1].v).forEach(([p, s]) => {
            tBody.innerHTML += `<tr><td>${p}</td><td>${s.p}</td><td>${s.v}</td><td><span class="badge-win">${Math.round((s.v/s.p)*100)}%</span></td></tr>`;
        });

        const hBody = document.getElementById('history-body'); hBody.innerHTML = '';
        historial.slice(0, 10).forEach(p => { hBody.innerHTML += `<tr><td>${new Date(p.timestamp).toLocaleDateString()}</td><td>${p.p1.join("/")}</td><td>${p.s1}-${p.s2}</td><td>${p.p2.join("/")}</td></tr>`; });

        // GrÃ¡fico
        const ctx = document.getElementById('myChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(ind), datasets: [{ label: 'Victorias', data: Object.values(ind).map(s=>s.v), backgroundColor: '#2ecc71' }, { label: 'Partidos', data: Object.values(ind).map(s=>s.p), backgroundColor: '#3498db' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function borrarTodo() { if (confirm("Â¿Borrar todo?")) { localStorage.clear(); location.reload(); } }

    renderJugadores();
    actualizarInterfaz();
</script>
<!-- end list -->
</body>
</html>